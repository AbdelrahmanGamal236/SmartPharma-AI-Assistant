{% extends "base.html" %}

{% block title %}Medicine Search{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="text-center mb-0">
                        <i class="fas fa-search me-2"></i>Medicine Search
                    </h2>
                </div>
                <div class="card-body">
                    <form id="medicine-search-form" class="mb-4">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="medicine_name" 
                                class="form-control" 
                                placeholder="Enter medicine name..." 
                                oninput="showSuggestions()"
                                aria-label="Medicine search input"
                            >
                            <button 
                                class="btn btn-outline-secondary" 
                                type="button" 
                                onclick="clearSuggestions()"
                                title="Clear suggestions"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                            <button 
                                class="btn btn-primary" 
                                type="button" 
                                onclick="searchMedicine()"
                            >
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                        <div 
                            id="suggestions" 
                            class="list-group position-absolute" 
                            style="z-index: 1000; display: none; width: calc(100% - 30px);"
                        ></div>
                    </form>

                    <div id="loading" class="text-center text-muted" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Searching for medicine...</p>
                    </div>

                    <div id="output"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function clearSuggestions() {
        const suggestionsBox = document.getElementById('suggestions');
        const inputField = document.getElementById('medicine_name');
        
        // Clear input field
        inputField.value = '';
        
        // Hide and clear suggestions
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
    }

    function showSuggestions() {
        const input = document.getElementById('medicine_name').value;
        const suggestionsBox = document.getElementById('suggestions');
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';

        if (input.length < 1) return;

        fetch('/api/medicine-autocomplete?term=' + encodeURIComponent(input))
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    suggestionsBox.style.display = 'block';
                    data.forEach(item => {
                        const suggestionItem = document.createElement('a');
                        suggestionItem.href = '#';
                        suggestionItem.className = 'list-group-item list-group-item-action';
                        suggestionItem.textContent = item;
                        suggestionItem.onclick = (e) => {
                            e.preventDefault();
                            document.getElementById('medicine_name').value = item;
                            suggestionsBox.style.display = 'none';
                        };
                        suggestionsBox.appendChild(suggestionItem);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
            });
    }

    function searchMedicine() {
        const medicineName = document.getElementById('medicine_name').value;
        const outputDiv = document.getElementById('output');
        const loadingDiv = document.getElementById('loading');
        const suggestionsBox = document.getElementById('suggestions');

        // Clear suggestions
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';

        // Clear previous results and show loading
        outputDiv.innerHTML = '';
        loadingDiv.style.display = 'block';

        fetch('/api/medicine-search?medicine_name=' + encodeURIComponent(medicineName))
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';

                if (data.message) {
                    outputDiv.innerHTML = `
                        <div class="alert alert-warning text-center" role="alert">
                            ${data.message}
                        </div>
                    `;
                    return;
                }

                let resultHTML = data.map(item => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-pills me-2 text-primary"></i>${item.name || 'N/A'}
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Substitutes:</strong> 
                                        ${[item.substitute0, item.substitute1, item.substitute2].filter(Boolean).join(', ') || 'None'}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Side Effects:</strong> 
                                        ${[item.sideEffect0, item.sideEffect1].filter(Boolean).join(', ') || 'None'}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Uses:</strong> ${item.use0 || 'N/A'}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Habit Forming:</strong> ${item.habit_forming || 'Unknown'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                outputDiv.innerHTML = resultHTML;
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                outputDiv.innerHTML = `
                    <div class="alert alert-danger text-center" role="alert">
                        Error searching medicine: ${error.message}
                    </div>
                `;
                console.error('Search error:', error);
            });
    }
</script>
{% endblock %}
