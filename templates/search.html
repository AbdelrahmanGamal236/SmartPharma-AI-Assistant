{% extends "base.html" %}

{% block title %}Medicine Search{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        <i class="fas fa-search me-2"></i>Medicine Search
                    </h2>
                </div>
                <div class="card-body">
                    <form id="medicine-search-form" class="mb-4">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="medicine_name" 
                                class="form-control" 
                                placeholder="Enter medicine name..." 
                                aria-label="Medicine Name"
                                oninput="showSuggestions()"
                                onkeydown="if(event.key === 'Escape') { document.getElementById('medicine_name').value = ''; document.getElementById('output').innerHTML = ''; hideSuggestions(); }"
                            >
                            <button 
                                class="btn btn-primary" 
                                type="button" 
                                onclick="searchMedicine()"
                            >
                                <i class="fas fa-search me-1"></i>Search
                            </button>
                        </div>
                        <div 
                            id="suggestions" 
                            class="list-group position-absolute" 
                            style="z-index: 1000; display: none; width: 100%;"
                        ></div>
                    </form>

                    <div id="loading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div id="output"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add event listener to hide suggestions when clicking outside
    document.addEventListener('click', function(event) {
        const suggestionsBox = document.getElementById('suggestions');
        const medicineInput = document.getElementById('medicine_name');
        
        // Check if the click is outside the suggestions and input
        if (!suggestionsBox.contains(event.target) && 
            !medicineInput.contains(event.target)) {
            hideSuggestions();
        }
    });

    function hideSuggestions() {
        const suggestionsBox = document.getElementById('suggestions');
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
    }

    function showSuggestions() {
        const input = document.getElementById('medicine_name').value;
        const suggestionsBox = document.getElementById('suggestions');
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';

        if (input.length < 1) {
            hideSuggestions();
            document.getElementById('output').innerHTML = '';
            return;
        }

        fetch('/autocomplete?term=' + encodeURIComponent(input))
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    suggestionsBox.style.display = 'block';
                    data.forEach(item => {
                        const suggestionItem = document.createElement('a');
                        suggestionItem.href = '#';
                        suggestionItem.className = 'list-group-item list-group-item-action';
                        suggestionItem.textContent = item;
                        suggestionItem.onclick = (e) => {
                            e.preventDefault();
                            document.getElementById('medicine_name').value = item;
                            hideSuggestions();
                        };
                        suggestionsBox.appendChild(suggestionItem);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
            });
    }

    function searchMedicine() {
        const medicineName = document.getElementById('medicine_name').value;
        const outputDiv = document.getElementById('output');
        const loadingDiv = document.getElementById('loading');

        // Hide suggestions when searching
        hideSuggestions();

        // Clear previous results and show loading
        outputDiv.innerHTML = '';
        loadingDiv.style.display = 'block';

        fetch('/api_search_med?medicine_name=' + encodeURIComponent(medicineName))
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';

                if (data.message) {
                    outputDiv.innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            ${data.message}
                        </div>
                    `;
                    return;
                }

                let resultHTML = data.map(item => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-pills me-2"></i>${item.name || 'N/A'}</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Substitutes:</strong> ${[item.substitute0, item.substitute1, item.substitute2].filter(Boolean).join(', ') || 'None'}</p>
                                    <p><strong>Side Effects:</strong> ${[item.sideEffect0, item.sideEffect1].filter(Boolean).join(', ') || 'None'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Uses:</strong> ${item.use0 || 'N/A'}</p>
                                    <p><strong>Habit Forming:</strong> ${item.habit_forming || 'Unknown'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                outputDiv.innerHTML = resultHTML;
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                outputDiv.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error searching medicine: ${error.message}
                    </div>
                `;
                console.error('Search error:', error);
            });
    }
</script>
{% endblock %}
